<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="一个记录学习和成长的地方"><title>PHP 实现微信关注公众号或扫码实现获取用户信息 | eiaha</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '31b1fec5b38eff90d9b255c21ce372a0';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">PHP 实现微信关注公众号或扫码实现获取用户信息</h1><a id="logo" href="/.">eiaha</a><p class="description">eiaha 的个人博客</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">PHP 实现微信关注公众号或扫码实现获取用户信息</h1><div class="post-meta">2019-12-09<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.3k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i><span class="post-count"> 6</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><blockquote>
<p>用户可通过扫描二维码进行关注或单纯进行扫码操作，实现获取用户微信信息，提高公众号关注率</p>
</blockquote>
<h2 id="详细"><a href="#详细" class="headerlink" title="详细"></a>详细</h2><h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><p><img src="https://img-blog.csdnimg.cn/20191209221754677.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTIyMjIyNDg=,size_16,color_FFFFFF,t_70" alt="扫码登录流程图"></p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><h4 id="准备公众号及配置"><a href="#准备公众号及配置" class="headerlink" title="准备公众号及配置"></a>准备公众号及配置</h4><p>本文用测试公众号进行配置举例</p>
<p><img src="https://img-blog.csdnimg.cn/20191209221247457.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTIyMjIyNDg=,size_16,color_FFFFFF,t_70" alt="我的测试账号"></p>
<h2 id="相关接口文档"><a href="#相关接口文档" class="headerlink" title="相关接口文档"></a>相关接口文档</h2><h4 id="获取access-token"><a href="#获取access-token" class="headerlink" title="获取access_token"></a>获取access_token</h4><p>文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Basic_Information/Get_access_token.html" target="_blank" rel="noopener">获取access_token</a></p>
<h4 id="生成临时带参二维码"><a href="#生成临时带参二维码" class="headerlink" title="生成临时带参二维码"></a>生成临时带参二维码</h4><p>临时带参二维码方式进行生成二维码，再采用微信事件回调进行用户信息获取。<br>带参二维码生成文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Generating_a_Parametric_QR_Code.html" target="_blank" rel="noopener">生成带参二维码</a></p>
<h4 id="用户事件回调"><a href="#用户事件回调" class="headerlink" title="用户事件回调"></a>用户事件回调</h4><p>用户在进行扫码或其他事件，微信会进行事件回调。<br>微信事件回调文档：<a href="https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Receiving_event_pushes.html" target="_blank" rel="noopener">微信事件回调</a></p>
<h4 id="获取用户详细信息"><a href="#获取用户详细信息" class="headerlink" title="获取用户详细信息"></a>获取用户详细信息</h4><p>获取用户详细信息：<a href="https://developers.weixin.qq.com/doc/offiaccount/User_Management/Get_users_basic_information_UnionID.html#UinonId" target="_blank" rel="noopener">获取用户详细信息</a></p>
<h2 id="详细程序实现-仅供参考"><a href="#详细程序实现-仅供参考" class="headerlink" title="详细程序实现-仅供参考"></a>详细程序实现-仅供参考</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Class WechatController</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@package</span> \\$&#123;NAMESPACE&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WechatController</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $_token = <span class="string">"onepie"</span>;</span><br><span class="line">    <span class="keyword">private</span> $appid = <span class="string">'******'</span>;</span><br><span class="line">    <span class="keyword">private</span> $secrect = <span class="string">'******'</span>;</span><br><span class="line">    <span class="keyword">private</span> $accessToken = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> $qrcode_url = <span class="string">"https://api.weixin.qq.com/cgi-bin/qrcode/create?"</span>;</span><br><span class="line">    <span class="keyword">static</span> $token_url = <span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;"</span>;</span><br><span class="line">    <span class="keyword">static</span> $qrcode_get_url = <span class="string">"https://mp.weixin.qq.com/cgi-bin/showqrcode?"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">indexAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fqid = rand(<span class="number">1000000</span>, <span class="number">99999999</span>);</span><br><span class="line">        $ACCESS_TOKEN = <span class="keyword">$this</span>-&gt;getToken(<span class="keyword">$this</span>-&gt;appid, <span class="keyword">$this</span>-&gt;secrect);</span><br><span class="line">        $url = <span class="keyword">$this</span>-&gt;getQrcodeurl($ACCESS_TOKEN, $fqid, <span class="number">2</span>);</span><br><span class="line">        file_put_contents(LOG_PATH . <span class="string">'/wx.log'</span>, $fqid, FILE_APPEND);</span><br><span class="line">        $img_url = <span class="keyword">$this</span>-&gt;DownLoadQr($url, <span class="string">'qrcode'</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setData(<span class="string">'qrcode_url'</span>, $img_url);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;setView(<span class="string">'index'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取关注二维码ticket</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>     $ACCESS_TOKEN</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>     $fqid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $type</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getQrcodeurl</span><span class="params">($ACCESS_TOKEN, $fqid, $type = <span class="number">1</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $url = <span class="keyword">self</span>::$qrcode_url . <span class="string">'access_token='</span> . $ACCESS_TOKEN;</span><br><span class="line">        <span class="keyword">if</span> ($type == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">//生成永久二维码</span></span><br><span class="line">            $qrcode = <span class="string">'&#123;"action_name": "QR_LIMIT_SCENE", "action_info": &#123;"scene": &#123;"scene_str": '</span> . $fqid . <span class="string">'&#125;&#125;&#125;'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//生成临时二维码</span></span><br><span class="line">            $qrcode = <span class="string">'&#123;"expire_seconds": 604800, "action_name": "QR_STR_SCENE", "action_info": &#123;"scene": &#123;"scene_str": '</span> . $fqid . <span class="string">'&#125;&#125;&#125;'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $result = http_post_data($url, $qrcode);</span><br><span class="line">        $oo = json_decode($result[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">empty</span>($oo-&gt;ticket)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!$oo-&gt;ticket) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ErrorLogger(<span class="string">'getQrcodeurl falied. Error Info: getQrcodeurl get failed'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        $url = <span class="keyword">self</span>::$qrcode_get_url . <span class="string">'ticket='</span> . $oo-&gt;ticket . <span class="string">''</span>;</span><br><span class="line">        <span class="keyword">echo</span> $oo-&gt;ticket;</span><br><span class="line">        <span class="keyword">return</span> $url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存二维码到服务器</span></span><br><span class="line"><span class="comment">     * 可直接进行展示不进行存储，看业务需求</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $filestring</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool|string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">DownLoadQr</span><span class="params">($url, $filestring)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($url == <span class="string">""</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $filename = $filestring . rand(<span class="number">0</span>, <span class="number">99999999999</span>) . <span class="string">'.jpg'</span>;</span><br><span class="line">        ob_start();</span><br><span class="line">        readfile($url);</span><br><span class="line">        $img = ob_get_contents();</span><br><span class="line">        ob_end_clean();</span><br><span class="line">        <span class="comment">/*if (!file_exists('/public/qrcode/' . $filename)) &#123;</span></span><br><span class="line"><span class="comment">            touch('/public/qrcode/' . $filename);</span></span><br><span class="line"><span class="comment">        &#125;*/</span></span><br><span class="line">        $file = PUBLIC_PATH . <span class="string">'qrcode/'</span> . $filename;</span><br><span class="line">        $fp2 = fopen($file, <span class="string">"a"</span>);</span><br><span class="line">        <span class="keyword">if</span> (fwrite($fp2, $img) === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;ErrorLogger(<span class="string">'dolwload image falied. Error Info: 无法写入图片'</span>);</span><br><span class="line">            <span class="keyword">exit</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        fclose($fp2);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'/public/qrcode/'</span> . $filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $appid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $appsecret</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     * 获取token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getToken</span><span class="params">($appid, $appsecret)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $url = <span class="string">"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&amp;appid="</span> . $appid . <span class="string">"&amp;secret="</span> . $appsecret;</span><br><span class="line">        $token = request_get($url);</span><br><span class="line">        $token = json_decode(stripslashes($token));</span><br><span class="line">        $arr = json_decode(json_encode($token), <span class="keyword">true</span>);</span><br><span class="line">        $access_token = $arr[<span class="string">'access_token'</span>];</span><br><span class="line">        <span class="keyword">return</span> $access_token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serviceAction</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;showPage = <span class="keyword">false</span>;</span><br><span class="line">        $echoStr = @$_GET[<span class="string">"echostr"</span>];</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">isset</span>($echoStr)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;responseMsg();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;valid();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $nonce = $_GET[<span class="string">'nonce'</span>];</span><br><span class="line">        $token = <span class="keyword">$this</span>-&gt;_token;</span><br><span class="line">        $timestamp = $_GET[<span class="string">'timestamp'</span>];</span><br><span class="line">        $echostr = $_GET[<span class="string">'echostr'</span>];</span><br><span class="line">        $signature = $_GET[<span class="string">'signature'</span>];</span><br><span class="line">        <span class="comment">//形成数组，然后按字典序排序</span></span><br><span class="line">        $array = <span class="keyword">array</span>($nonce, $timestamp, $token);</span><br><span class="line">        sort($array);</span><br><span class="line">        <span class="comment">//拼接成字符串,sha1加密 ，然后与signature进行校验</span></span><br><span class="line">        $str = sha1(implode($array));</span><br><span class="line">        <span class="keyword">if</span> ($str == $signature) &#123;</span><br><span class="line">            <span class="keyword">echo</span> $echostr;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信事件推送接收方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">responseMsg</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $postStr = <span class="keyword">isset</span>($GLOBALS[<span class="string">'HTTP_RAW_POST_DATA'</span>]) ? $GLOBALS[<span class="string">'HTTP_RAW_POST_DATA'</span>] : file_get_contents(<span class="string">"php://input"</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($postStr)) &#123;</span><br><span class="line">            $postObj = simplexml_load_string($postStr, <span class="string">'SimpleXMLElement'</span>, LIBXML_NOCDATA);</span><br><span class="line">            <span class="comment">// 微信消息类型</span></span><br><span class="line">            $RX_TYPE = trim($postObj-&gt;MsgType);</span><br><span class="line">            <span class="keyword">switch</span> ($RX_TYPE) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"text"</span>:</span><br><span class="line">                    <span class="comment">// 文本消息</span></span><br><span class="line">                    $resultStr = <span class="keyword">$this</span>-&gt;handleText($postObj);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">"event"</span>:</span><br><span class="line">                    <span class="comment">// 事件推送</span></span><br><span class="line">                    $resultStr = <span class="keyword">$this</span>-&gt;handleEvent($postObj);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    $resultStr = <span class="string">"Unknow msg type: "</span> . $RX_TYPE;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">echo</span> $resultStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">""</span>;</span><br><span class="line">            <span class="keyword">exit</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 微信文本消息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $postObj</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleText</span><span class="params">($postObj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $fromUsername = $postObj-&gt;FromUserName;</span><br><span class="line">        $toUsername = $postObj-&gt;ToUserName;</span><br><span class="line">        $keyword = trim($postObj-&gt;Content);</span><br><span class="line">        $time = time();</span><br><span class="line">        $textTpl = <span class="string">"&lt;xml&gt;</span></span><br><span class="line"><span class="string">                    &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">                    &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">                    &lt;CreateTime&gt;%s&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">                    &lt;MsgType&gt;&lt;![CDATA[%s]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">                    &lt;Content&gt;&lt;![CDATA[%s]]&gt;&lt;/Content&gt;</span></span><br><span class="line"><span class="string">                    &lt;FuncFlag&gt;0&lt;/FuncFlag&gt;</span></span><br><span class="line"><span class="string">                    &lt;/xml&gt;"</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($keyword)) &#123;</span><br><span class="line">            $msgType = <span class="string">"text"</span>;</span><br><span class="line">            $contentStr = <span class="string">"欢迎您关注"</span>;</span><br><span class="line">            $resultStr = sprintf($textTpl, $fromUsername, $toUsername, $time, $msgType, $contentStr);</span><br><span class="line">            <span class="keyword">echo</span> $resultStr;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"lalala"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取时间消息并解析相应参数</span></span><br><span class="line"><span class="comment">     * 提供数据简单推送(自动回复)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleEvent</span><span class="params">($object)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $contentStr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">switch</span> ($object-&gt;Event) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"subscribe"</span>:</span><br><span class="line">                $contentStr = <span class="string">"感谢您关注【测试账号】"</span>;</span><br><span class="line">                $openid = (string)$object-&gt;FromUserName; <span class="comment">//数据类型转换为字符串,mmp这个问题找了好久</span></span><br><span class="line">                $refer_id = explode(<span class="string">'_'</span>, $object-&gt;EventKey); <span class="comment">//$object-&gt;EventKey返回的是qrsence_123这种类型</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;createuserinfo($openid, $refer_id[<span class="number">1</span>]);<span class="comment">//获取用户信息</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">"SCAN"</span>:</span><br><span class="line">                $contentStr = <span class="string">"您已关注过，谢谢！"</span>;</span><br><span class="line">                $openid = (string)$object-&gt;FromUserName; <span class="comment">//数据类型转换为字符串,mmp这个问题找了好久</span></span><br><span class="line">                $refer_id = explode(<span class="string">'_'</span>, $object-&gt;EventKey); <span class="comment">//$object-&gt;EventKey返回的是qrsence_123这种类型</span></span><br><span class="line">                <span class="keyword">$this</span>-&gt;createuserinfo($openid, $refer_id[<span class="number">0</span>]);<span class="comment">//获取用户信息</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $resultStr = <span class="keyword">$this</span>-&gt;responseText($object, $contentStr);</span><br><span class="line">        <span class="keyword">return</span> $resultStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 消息回复模板</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>     $object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>     $content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> int $flag</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">responseText</span><span class="params">($object, $content, $flag = <span class="number">0</span>)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $textTpl = <span class="string">"&lt;xml&gt;</span></span><br><span class="line"><span class="string">                    &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;</span></span><br><span class="line"><span class="string">                    &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;</span></span><br><span class="line"><span class="string">                    &lt;CreateTime&gt;%s&lt;/CreateTime&gt;</span></span><br><span class="line"><span class="string">                    &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;</span></span><br><span class="line"><span class="string">                    &lt;Content&gt;&lt;![CDATA[%s]]&gt;&lt;/Content&gt;</span></span><br><span class="line"><span class="string">                    &lt;FuncFlag&gt;%d&lt;/FuncFlag&gt;</span></span><br><span class="line"><span class="string">                    &lt;/xml&gt;"</span>;</span><br><span class="line">        $resultStr = sprintf($textTpl, $object-&gt;FromUserName, $object-&gt;ToUserName, time(), $content, $flag);</span><br><span class="line">        <span class="keyword">return</span> $resultStr;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取用户详细信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $openid</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> $refer_id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">createuserinfo</span><span class="params">($openid, $refer_id)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $url = <span class="string">"https://api.weixin.qq.com/cgi-bin/user/info?access_token="</span> . <span class="keyword">$this</span>-&gt;getToken(<span class="keyword">$this</span>-&gt;appid, <span class="keyword">$this</span>-&gt;secrect) . <span class="string">"&amp;openid="</span> . $openid;</span><br><span class="line">        $user = request_get($url);</span><br><span class="line">        $user = json_decode($user, <span class="keyword">true</span>);</span><br><span class="line">        $users = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'openid'</span> =&gt; $openid,</span><br><span class="line">            <span class="string">'nickname'</span> =&gt; $user[<span class="string">'nickname'</span>],</span><br><span class="line">            <span class="string">'avatar'</span> =&gt; $user[<span class="string">'headimgurl'</span>],</span><br><span class="line">            <span class="string">'sex'</span> =&gt; $user[<span class="string">'sex'</span>],</span><br><span class="line">            <span class="string">'unionid'</span> =&gt; $user[<span class="string">'unionid'</span>],</span><br><span class="line">            <span class="string">'status'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">'reg_time'</span> =&gt; $user[<span class="string">'subscribe_time'</span>],<span class="comment">//关注公众号的时间</span></span><br><span class="line">            <span class="string">'bind_user'</span> =&gt; $refer_id</span><br><span class="line">        );</span><br><span class="line">        $user_str = date(<span class="string">'Y-m-d H:i:s'</span>) . <span class="string">"\t"</span>;</span><br><span class="line">        <span class="keyword">foreach</span> ($users <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">            $user_str .= $key . <span class="string">'='</span> . $value . <span class="string">"\t"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $user_str .= <span class="string">"\n"</span>;</span><br><span class="line">        file_put_contents(LOG_PATH . <span class="string">"wx.log"</span>, $user_str, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>PHP 实现微信关注公众号或扫码实现获取用户信息</p><p><span>文章作者：</span>eiaha</p><p><span>发布时间：</span>2019-12-09</p><p><span>最后更新：</span>2020-06-22</p><p><span>原始链接：</span><a href="/201912/wx-scan-login.html">http://blog.onepie.cn/201912/wx-scan-login.html</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="http://blog.onepie.cn/201912/wx-scan-login.html"></i></span></p><p><span>版权声明：</span>本文所有内容，包括文字、图片,均为原创。对未经许可擅自使用者，保留追究其法律责任的权利。</p></div><br><div class="tags"><a href="/tags/php/"><i class="fa fa-tag"></i>php</a></div><div class="post-nav"><a class="pre" href="/201912/fiddler-show-ip.html">Fiddler 显示服务器ip地址</a><a class="next" href="/201903/php-bug-01.html">PHP 位运算操作字符串类型的数字产生的Bug</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/php-aes/" style="font-size: 15px;">php-aes</a> <a href="/tags/git/" style="font-size: 15px;">git</a> <a href="/tags/js-aes/" style="font-size: 15px;">js-aes</a> <a href="/tags/laravel/" style="font-size: 15px;">laravel</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/linux-close/" style="font-size: 15px;">linux close</a> <a href="/tags/macos/" style="font-size: 15px;">macos</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/linux-centos/" style="font-size: 15px;">linux-centos</a> <a href="/tags/php-bug/" style="font-size: 15px;">php-bug</a> <a href="/tags/php-https/" style="font-size: 15px;">php_https</a> <a href="/tags/Fiddler/" style="font-size: 15px;">Fiddler</a> <a href="/tags/php/" style="font-size: 15px;">php</a> <a href="/tags/redis/" style="font-size: 15px;">redis</a> <a href="/tags/gitlab/" style="font-size: 15px;">gitlab</a> <a href="/tags/gitlab-%E5%8D%B8%E8%BD%BD/" style="font-size: 15px;">gitlab 卸载</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/202006/unstall-gitlab.html">linux 卸载gitlab</a></li><li class="post-list-item"><a class="post-list-link" href="/202006/php-get-top-host.html">PHP 根据url获取顶级域名</a></li><li class="post-list-item"><a class="post-list-link" href="/202006/php-http-status.html">PHP 实现各类状态码</a></li><li class="post-list-item"><a class="post-list-link" href="/202006/js-aes.html">JS 实现AES加解密</a></li><li class="post-list-item"><a class="post-list-link" href="/202006/php-aes.html">PHP 实现AES加解密</a></li><li class="post-list-item"><a class="post-list-link" href="/202006/php-get-http.html">PHP 获取请求协议</a></li><li class="post-list-item"><a class="post-list-link" href="/201912/linux-unzip.html">Linux 解压文件 解压命令</a></li><li class="post-list-item"><a class="post-list-link" href="/201912/fiddler-show-ip.html">Fiddler 显示服务器ip地址</a></li><li class="post-list-item"><a class="post-list-link" href="/201912/wx-scan-login.html">PHP 实现微信关注公众号或扫码实现获取用户信息</a></li><li class="post-list-item"><a class="post-list-link" href="/201903/php-bug-01.html">PHP 位运算操作字符串类型的数字产生的Bug</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.csdn.net/u012222248" title="洋灰的博客(本人CSDN博客)" target="_blank">洋灰的博客(本人CSDN博客)</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2020 <a href="/." rel="nofollow">eiaha.</a> <a rel="nofollow" target="_blank" href="http://www.beian.miit.gov.cn/"> 浙ICP备16031707号-4.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" color="245,255,250" opacity="0.3" zIndex="-1" count="100" src="//cdn.jsdelivr.net/npm/canvas-nest.js/dist/canvas-nest.min.js"></script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>